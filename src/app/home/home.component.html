<main class="main">
  <div class="container">
    <h1>üçï WebPizza AI/RAG POC</h1>
    <p class="subtitle">Private Document Chat - 100% Client-Side AI</p>
    
    <!-- Browser Error Section -->
    <div *ngIf="showBrowserError" class="error-section card">
      <h2>‚ö†Ô∏è WebGPU Not Available</h2>
      <p class="error-message">{{ browserErrorDetails }}</p>
      
      <div class="setup-instructions">
        <h3>üîß Quick Fix:</h3>
        <ol>
          <li>
            <strong>Visit:</strong> 
            <a href="chrome://flags" target="_blank">chrome://flags</a> or 
            <a href="edge://flags" target="_blank">edge://flags</a>
          </li>
          <li><strong>Search:</strong> "WebGPU"</li>
          <li><strong>Enable:</strong> "Unsafe WebGPU"</li>
          <li><strong>Relaunch</strong> browser</li>
          <li><strong>Refresh</strong> this page</li>
        </ol>
        
        <h3>üìã Requirements:</h3>
        <ul>
          <li>‚úÖ Chrome 113+ or Edge 113+</li>
          <li>‚úÖ 4GB+ RAM available</li>
          <li>‚úÖ Modern GPU (Intel HD 5500+, NVIDIA GTX 650+, AMD HD 7750+)</li>
          <li>‚úÖ Hardware acceleration enabled</li>
        </ul>
        
        <h3>üß™ Test Your Browser:</h3>
        <p>
          <a href="https://webgpureport.org/" target="_blank" class="test-button">
            Check WebGPU Support ‚Üí
          </a>
        </p>
        
        <details class="troubleshooting">
          <summary>üêõ More Troubleshooting</summary>
          <div class="troubleshooting-content">
            <h4>Still not working?</h4>
            <ul>
              <li>Update your browser to latest version</li>
              <li>Update graphics drivers</li>
              <li>Enable hardware acceleration: <code>chrome://settings/system</code></li>
              <li>Try Chrome Canary: <a href="https://www.google.com/chrome/canary/" target="_blank">Download</a></li>
              <li>Check console (F12) for detailed errors</li>
            </ul>
            <p><strong>Current browser:</strong><br><code>{{ getBrowserInfo() }}</code></p>
          </div>
        </details>
      </div>
    </div>
    
    <div *ngIf="loading && !showBrowserError" class="loading-section">
      <h2>üîÑ Loading AI Models...</h2>
      
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="loadingProgress"></div>
        </div>
        <div class="progress-percentage">{{ loadingProgress }}%</div>
      </div>
      
      <p class="progress-text">{{ initProgress || 'Initializing...' }}</p>
      
      <div class="loading-steps">
        <div class="step" [class.active]="currentStep >= 1" [class.complete]="currentStep > 1">
          <span class="step-icon">{{ currentStep > 1 ? '‚úÖ' : currentStep === 1 ? '‚è≥' : '‚è∏Ô∏è' }}</span>
          <span>LLM Model</span>
        </div>
        <div class="step" [class.active]="currentStep >= 2" [class.complete]="currentStep > 2">
          <span class="step-icon">{{ currentStep > 2 ? '‚úÖ' : currentStep === 2 ? '‚è≥' : '‚è∏Ô∏è' }}</span>
          <span>Embedder</span>
        </div>
        <div class="step" [class.active]="currentStep >= 3" [class.complete]="currentStep > 3">
          <span class="step-icon">{{ currentStep > 3 ? '‚úÖ' : currentStep === 3 ? '‚è≥' : '‚è∏Ô∏è' }}</span>
          <span>Vector Store</span>
        </div>
      </div>
      
      <p class="info">First load may take a few minutes (downloading model files)</p>
    </div>
    
    <div *ngIf="!loading" class="chat-layout">
      <!-- Collapsible Setup Section -->
      <div class="setup-section" [class.collapsed]="!showSetupSection">
        <button class="toggle-setup-button" (click)="toggleSetup()">
          {{ showSetupSection ? '‚ñº' : '‚ñ∂' }} {{ showSetupSection ? 'Hide' : 'Show' }} Setup
        </button>
        
        <div class="setup-content" *ngIf="showSetupSection">
          <section class="engine-section card">
        <h2>‚ö° Engine Selection</h2>
        <div class="engine-selector">
          <label class="radio-label">
            <input 
              type="radio" 
              name="engine" 
              value="webllm" 
              [(ngModel)]="selectedEngine"
              (change)="onEngineChange()"
              [disabled]="isModelLoaded"
            />
            <span class="radio-text">
              <strong>WebLLM</strong> (Standard)
              <small>Original implementation</small>
            </span>
          </label>
          <label class="radio-label">
            <input 
              type="radio" 
              name="engine" 
              value="weinfer" 
              [(ngModel)]="selectedEngine"
              (change)="onEngineChange()"
              [disabled]="isModelLoaded"
            />
            <span class="radio-text">
              <strong>WeInfer</strong> (Optimized)
              <small>‚ö° ~3.76x faster with buffer reuse + async pipeline</small>
            </span>
          </label>
          <p class="hint" *ngIf="!isModelLoaded">
            üí° WeInfer offers significant performance improvements through GPU buffer reuse and asynchronous pipeline processing.
          </p>
          <p class="hint success" *ngIf="isModelLoaded">
            ‚úÖ Engine: {{ selectedEngine === 'weinfer' ? 'WeInfer (Optimized)' : 'WebLLM (Standard)' }}
          </p>
        </div>
      </section>
      
      <section class="model-section card">
        <h2>ü§ñ Model Selection</h2>
        <div class="model-selector">
          <label for="modelSelect">Choose LLM Model:</label>
          <select 
            id="modelSelect" 
            [(ngModel)]="selectedModel"
            (change)="onModelChange()"
            [disabled]="isModelLoaded"
            class="model-select"
          >
            <option value="" disabled selected>-- Select an LLM Model --</option>
            <option *ngFor="let model of availableModels" [value]="model.id">
              {{ model.name }} - {{ model.size }} ({{ model.speed }}, {{ model.quality }})
            </option>
          </select>
          <p class="hint" *ngIf="!isModelLoaded && !selectedModel">
            üëÜ Choose a model to get started. Faster models = quicker responses but lower quality.
          </p>
          <p class="hint warning" *ngIf="!isModelLoaded && selectedModel">
            ‚è≥ Initializing model... This may take a few minutes on first load.
          </p>
          <p class="hint success" *ngIf="isModelLoaded">
            ‚úÖ Model loaded: {{ getCurrentModelName() }}
          </p>
        </div>
      </section>
      
      <section class="rag-options-section card">
        <h2>‚öôÔ∏è RAG Options</h2>
        <div class="options-grid">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="enableSourceCitations"
              [disabled]="querying"
            />
            <span class="checkbox-text">
              <strong>üìñ Source Citations</strong>
              <small>Show page numbers in answers</small>
            </span>
          </label>
          
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="enableConversationalMemory"
              [disabled]="querying"
            />
            <span class="checkbox-text">
              <strong>üí≠ Conversational Memory</strong>
              <small>Remember previous questions for follow-ups</small>
            </span>
          </label>
          
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="enableHybridSearch"
              [disabled]="querying"
            />
            <span class="checkbox-text">
              <strong>üîç Hybrid Search</strong>
              <small>Combine semantic (70%) + keyword (30%) search</small>
            </span>
          </label>
        </div>
        
        <div *ngIf="enableConversationalMemory && conversationHistory.length > 0" class="conversation-info">
          <p class="hint">üí≠ Conversation: {{ conversationHistory.length }} exchange(s)</p>
          <button 
            class="clear-conversation-button" 
            (click)="clearConversation()"
            [disabled]="querying"
          >
            üóëÔ∏è Clear Conversation
          </button>
        </div>
      </section>
      
      <section class="upload-section card">
        <h2>üìÑ Step 1: Upload PDF Document</h2>
        
        <div *ngIf="!isModelLoaded" class="hint warning">
          ‚ö†Ô∏è Please select and load a model first before uploading documents.
        </div>
        
        <div *ngIf="!uploading && !loadedDocumentName && isModelLoaded" class="upload-area">
          <input 
            type="file" 
            id="fileInput"
            accept=".pdf" 
            (change)="onFileUpload($event)"
            [disabled]="uploading || !isModelLoaded"
          />
          <label for="fileInput" class="upload-button" [class.disabled]="uploading || !isModelLoaded">
            üìé Choose PDF File
          </label>
        </div>
        
        <div *ngIf="uploading" class="upload-progress">
          <h3>üìÑ Processing: {{ uploadFileName }}</h3>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="uploadProgress"></div>
            </div>
            <div class="progress-percentage">{{ uploadProgress }}%</div>
          </div>
          <p class="progress-text">{{ uploadStatus }}</p>
        </div>
        
        <div *ngIf="!uploading && loadedDocumentName" class="loaded-document">
          <div class="document-info">
            <span class="document-icon">üìÑ</span>
            <span class="document-name">{{ loadedDocumentName }}</span>
          </div>
          <button class="change-document-button" (click)="loadedDocumentName = ''" title="Upload a different document">
            üîÑ Change Document
          </button>
        </div>
        
        <p class="hint">üí° Your document stays 100% local - never sent to any server</p>
      </section>
      </div>
    </div>
      
      <!-- Toast Notification -->
      <div *ngIf="showToast" class="toast" [class.success]="toastType === 'success'" [class.error]="toastType === 'error'">
        <span class="toast-icon">{{ toastType === 'success' ? '‚úÖ' : '‚ùå' }}</span>
        <span class="toast-message">{{ toastMessage }}</span>
      </div>
      
      <!-- Chat Area -->
      <div class="chat-section">
        <div class="chat-container" #chatContainer>
          <div *ngIf="chatMessages.length === 0" class="chat-empty-state">
            <div class="empty-icon">üí¨</div>
            <h3>Ready to chat!</h3>
            <p>Upload a PDF document and start asking questions.</p>
          </div>
          
          <div class="chat-messages">
            <div 
              *ngFor="let message of chatMessages" 
              class="message-wrapper"
              [class.user]="message.role === 'user'"
              [class.assistant]="message.role === 'assistant'"
            >
              <div class="message-bubble">
                <div class="message-content">{{ message.content }}</div>
                <div class="message-meta">
                  <span class="message-time">{{ message.timestamp | date:'HH:mm' }}</span>
                  <span *ngIf="message.sources && message.sources.length > 0" class="message-sources">
                    üìÑ Pages: {{ getPageNumbers(message.sources) }}
                  </span>
                </div>
              </div>
            </div>
            
            <!-- Typing indicator -->
            <div *ngIf="querying" class="message-wrapper assistant">
              <div class="message-bubble typing">
                <div class="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Fixed Input at Bottom -->
        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <input 
              type="text"
              [(ngModel)]="question"
              placeholder="Ask a question about your document..."
              [disabled]="querying || !loadedDocumentName"
              (keyup.enter)="onQuery()"
              class="chat-input"
            />
            <button 
              *ngIf="!querying"
              (click)="onQuery()"
              [disabled]="!question.trim() || !loadedDocumentName"
              class="send-button"
              [title]="!loadedDocumentName ? 'Upload a PDF first' : 'Send message'"
            >
              ‚û§
            </button>
            <button 
              *ngIf="querying"
              (click)="stopGeneration()"
              class="stop-button"
              title="Stop generation"
            >
              ‚èπ
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <footer class="footer">
      
      <section class="tech-info">
        <p><strong>Tech Stack:</strong> Angular 20 + WebLLM/WeInfer + Transformers.js + PDF.js + IndexedDB + WebGPU</p>
        <p><strong>Privacy:</strong> 100% client-side - all processing happens in your browser via WebGPU/WASM</p>
      </section>

      <div class="footer-content">
        <div class="footer-links">
          <a href="/privacy-policy" class="footer-link">Privacy Policy</a>
          <span class="footer-separator">‚Ä¢</span>
          <a href="/cookie-policy" class="footer-link">Cookie Policy</a>
        </div>
        <div class="footer-credits">
          Made with <span class="heart">‚ù§Ô∏è</span> by 
          <a href="https://emanuelestrazzullo.dev/" target="_blank" rel="noopener noreferrer" class="author-link">Emanuele Strazzullo</a>
          <span class="footer-separator">‚Ä¢</span>
          <a href="https://www.linkedin.com/in/emanuelestrazzullo/" target="_blank" rel="noopener noreferrer" class="social-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
            </svg>
            LinkedIn
          </a>
        </div>
        <div class="footer-version">
          v{{ appVersion }}
        </div>
      </div>
    </footer>
  </div>
</main>
