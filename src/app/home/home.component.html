<main class="main">
  <div class="container">
    <h1>ğŸ• WebPizza AI/RAG POC</h1>
    <p class="subtitle">Private Document Chat - 100% Client-Side AI</p>
    
    <!-- Browser Error Section -->
    <div *ngIf="showBrowserError" class="error-section card">
      <h2>âš ï¸ WebGPU Not Available</h2>
      <p class="error-message">{{ browserErrorDetails }}</p>
      
      <div class="setup-instructions">
        <h3>ğŸ”§ Quick Fix:</h3>
        <ol>
          <li>
            <strong>Visit:</strong> 
            <a href="chrome://flags" target="_blank">chrome://flags</a> or 
            <a href="edge://flags" target="_blank">edge://flags</a>
          </li>
          <li><strong>Search:</strong> "WebGPU"</li>
          <li><strong>Enable:</strong> "Unsafe WebGPU"</li>
          <li><strong>Relaunch</strong> browser</li>
          <li><strong>Refresh</strong> this page</li>
        </ol>
        
        <h3>ğŸ“‹ Requirements:</h3>
        <ul>
          <li>âœ… Chrome 113+ or Edge 113+</li>
          <li>âœ… 4GB+ RAM available</li>
          <li>âœ… Modern GPU (Intel HD 5500+, NVIDIA GTX 650+, AMD HD 7750+)</li>
          <li>âœ… Hardware acceleration enabled</li>
        </ul>
        
        <h3>ğŸ§ª Test Your Browser:</h3>
        <p>
          <a href="https://webgpureport.org/" target="_blank" class="test-button">
            Check WebGPU Support â†’
          </a>
        </p>
        
        <details class="troubleshooting">
          <summary>ğŸ› More Troubleshooting</summary>
          <div class="troubleshooting-content">
            <h4>Still not working?</h4>
            <ul>
              <li>Update your browser to latest version</li>
              <li>Update graphics drivers</li>
              <li>Enable hardware acceleration: <code>chrome://settings/system</code></li>
              <li>Try Chrome Canary: <a href="https://www.google.com/chrome/canary/" target="_blank">Download</a></li>
              <li>Check console (F12) for detailed errors</li>
            </ul>
            <p><strong>Current browser:</strong><br><code>{{ getBrowserInfo() }}</code></p>
          </div>
        </details>
      </div>
    </div>
    
    <div *ngIf="loading && !showBrowserError" class="loading-section">
      <h2>ğŸ”„ Loading AI Models...</h2>
      
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="loadingProgress"></div>
        </div>
        <div class="progress-percentage">{{ loadingProgress }}%</div>
      </div>
      
      <p class="progress-text">{{ initProgress || 'Initializing...' }}</p>
      
      <div class="loading-steps">
        <div class="step" [class.active]="currentStep >= 1" [class.complete]="currentStep > 1">
          <span class="step-icon">{{ currentStep > 1 ? 'âœ…' : currentStep === 1 ? 'â³' : 'â¸ï¸' }}</span>
          <span>LLM Model</span>
        </div>
        <div class="step" [class.active]="currentStep >= 2" [class.complete]="currentStep > 2">
          <span class="step-icon">{{ currentStep > 2 ? 'âœ…' : currentStep === 2 ? 'â³' : 'â¸ï¸' }}</span>
          <span>Embedder</span>
        </div>
        <div class="step" [class.active]="currentStep >= 3" [class.complete]="currentStep > 3">
          <span class="step-icon">{{ currentStep > 3 ? 'âœ…' : currentStep === 3 ? 'â³' : 'â¸ï¸' }}</span>
          <span>Vector Store</span>
        </div>
      </div>
      
      <p class="info">First load may take a few minutes (downloading model files)</p>
    </div>
    
    <div *ngIf="!loading" class="content-section">
      <section class="engine-section card">
        <h2>âš¡ Engine Selection</h2>
        <div class="engine-selector">
          <label class="radio-label">
            <input 
              type="radio" 
              name="engine" 
              value="webllm" 
              [(ngModel)]="selectedEngine"
              (change)="onEngineChange()"
              [disabled]="isModelLoaded"
            />
            <span class="radio-text">
              <strong>WebLLM</strong> (Standard)
              <small>Original implementation</small>
            </span>
          </label>
          <label class="radio-label">
            <input 
              type="radio" 
              name="engine" 
              value="weinfer" 
              [(ngModel)]="selectedEngine"
              (change)="onEngineChange()"
              [disabled]="isModelLoaded"
            />
            <span class="radio-text">
              <strong>WeInfer</strong> (Optimized)
              <small>âš¡ ~3.76x faster with buffer reuse + async pipeline</small>
            </span>
          </label>
          <p class="hint" *ngIf="!isModelLoaded">
            ğŸ’¡ WeInfer offers significant performance improvements through GPU buffer reuse and asynchronous pipeline processing.
          </p>
          <p class="hint success" *ngIf="isModelLoaded">
            âœ… Engine: {{ selectedEngine === 'weinfer' ? 'WeInfer (Optimized)' : 'WebLLM (Standard)' }}
          </p>
        </div>
      </section>
      
      <section class="model-section card">
        <h2>ğŸ¤– Model Selection</h2>
        <div class="model-selector">
          <label for="modelSelect">Choose LLM Model:</label>
          <select 
            id="modelSelect" 
            [(ngModel)]="selectedModel"
            (change)="onModelChange()"
            [disabled]="isModelLoaded"
            class="model-select"
          >
            <option value="" disabled selected>-- Select an LLM Model --</option>
            <option *ngFor="let model of availableModels" [value]="model.id">
              {{ model.name }} - {{ model.size }} ({{ model.speed }}, {{ model.quality }})
            </option>
          </select>
          <p class="hint" *ngIf="!isModelLoaded && !selectedModel">
            ğŸ‘† Choose a model to get started. Faster models = quicker responses but lower quality.
          </p>
          <p class="hint warning" *ngIf="!isModelLoaded && selectedModel">
            â³ Initializing model... This may take a few minutes on first load.
          </p>
          <p class="hint success" *ngIf="isModelLoaded">
            âœ… Model loaded: {{ getCurrentModelName() }}
          </p>
        </div>
      </section>
      
      <section class="rag-options-section card">
        <h2>âš™ï¸ RAG Options</h2>
        <div class="options-grid">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="enableSourceCitations"
              [disabled]="querying"
            />
            <span class="checkbox-text">
              <strong>ğŸ“– Source Citations</strong>
              <small>Show page numbers in answers</small>
            </span>
          </label>
          
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="enableConversationalMemory"
              [disabled]="querying"
            />
            <span class="checkbox-text">
              <strong>ğŸ’­ Conversational Memory</strong>
              <small>Remember previous questions for follow-ups</small>
            </span>
          </label>
          
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="enableHybridSearch"
              [disabled]="querying"
            />
            <span class="checkbox-text">
              <strong>ğŸ” Hybrid Search</strong>
              <small>Combine semantic (70%) + keyword (30%) search</small>
            </span>
          </label>
        </div>
        
        <div *ngIf="enableConversationalMemory && conversationHistory.length > 0" class="conversation-info">
          <p class="hint">ğŸ’­ Conversation: {{ conversationHistory.length }} exchange(s)</p>
          <button 
            class="clear-conversation-button" 
            (click)="clearConversation()"
            [disabled]="querying"
          >
            ğŸ—‘ï¸ Clear Conversation
          </button>
        </div>
      </section>
      
      <section class="upload-section card">
        <h2>ğŸ“„ Step 1: Upload PDF Document</h2>
        
        <div *ngIf="!isModelLoaded" class="hint warning">
          âš ï¸ Please select and load a model first before uploading documents.
        </div>
        
        <div *ngIf="!uploading && !loadedDocumentName && isModelLoaded" class="upload-area">
          <input 
            type="file" 
            id="fileInput"
            accept=".pdf" 
            (change)="onFileUpload($event)"
            [disabled]="uploading || !isModelLoaded"
          />
          <label for="fileInput" class="upload-button" [class.disabled]="uploading || !isModelLoaded">
            ğŸ“ Choose PDF File
          </label>
        </div>
        
        <div *ngIf="uploading" class="upload-progress">
          <h3>ğŸ“„ Processing: {{ uploadFileName }}</h3>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="uploadProgress"></div>
            </div>
            <div class="progress-percentage">{{ uploadProgress }}%</div>
          </div>
          <p class="progress-text">{{ uploadStatus }}</p>
        </div>
        
        <div *ngIf="!uploading && loadedDocumentName" class="loaded-document">
          <div class="document-info">
            <span class="document-icon">ğŸ“„</span>
            <span class="document-name">{{ loadedDocumentName }}</span>
          </div>
          <button class="change-document-button" (click)="loadedDocumentName = ''" title="Upload a different document">
            ğŸ”„ Change Document
          </button>
        </div>
        
        <p class="hint">ğŸ’¡ Your document stays 100% local - never sent to any server</p>
      </section>
      
      <!-- Toast Notification -->
      <div *ngIf="showToast" class="toast" [class.success]="toastType === 'success'" [class.error]="toastType === 'error'">
        <span class="toast-icon">{{ toastType === 'success' ? 'âœ…' : 'âŒ' }}</span>
        <span class="toast-message">{{ toastMessage }}</span>
      </div>
      
      <section class="query-section card">
        <h2>ğŸ’¬ Step 2: Ask Questions</h2>
        <div class="query-input-group">
          <input 
            type="text"
            [(ngModel)]="question"
            placeholder="What is this document about?"
            [disabled]="querying"
            (keyup.enter)="onQuery()"
            class="query-input"
          />
          <button 
            (click)="onQuery()"
            [disabled]="!question.trim() || querying"
            class="ask-button"
          >
            {{ querying ? 'ğŸ¤” Thinking...' : 'ğŸš€ Ask' }}
          </button>
        </div>
        
        <!-- Thinking Animation -->
        <div *ngIf="querying && !answer" class="thinking-animation">
          <div class="thinking-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
          <p class="thinking-text">AI is analyzing your document...</p>
        </div>
      </section>
      
      <section *ngIf="answer || querying" class="answer-section card">
        <h2>âœ¨ Answer:</h2>
        <div class="answer-content">
          <p *ngIf="answer">{{ answer }}</p>
          <div *ngIf="querying && answer" class="streaming-indicator">
            <span class="cursor-blink">â–Š</span>
          </div>
        </div>
      </section>
    </div>
    
    <footer class="footer">
      
      <section class="tech-info">
        <p><strong>Tech Stack:</strong> Angular 20 + WebLLM/WeInfer + Transformers.js + PDF.js + IndexedDB + WebGPU</p>
        <p><strong>Privacy:</strong> 100% client-side - all processing happens in your browser via WebGPU/WASM</p>
      </section>

      <div class="footer-content">
        <div class="footer-links">
          <a href="/privacy-policy" class="footer-link">Privacy Policy</a>
          <span class="footer-separator">â€¢</span>
          <a href="/cookie-policy" class="footer-link">Cookie Policy</a>
        </div>
        <div class="footer-credits">
          Made with <span class="heart">â¤ï¸</span> by 
          <a href="https://emanuelestrazzullo.dev/" target="_blank" rel="noopener noreferrer" class="author-link">Emanuele Strazzullo</a>
          <span class="footer-separator">â€¢</span>
          <a href="https://www.linkedin.com/in/emanuelestrazzullo/" target="_blank" rel="noopener noreferrer" class="social-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
            </svg>
            LinkedIn
          </a>
        </div>
        <div class="footer-version">
          v{{ appVersion }}
        </div>
      </div>
    </footer>
  </div>
</main>
